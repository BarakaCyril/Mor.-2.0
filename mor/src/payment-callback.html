<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Processing - Mor Cakes</title>
    <link rel="stylesheet" href="../src/styles/global.css">


    <style>
        .processing-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            text-align: center;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .processing-container h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #1a1a1a;
        }
        
        .processing-container p {
            font-size: 1.1rem;
            color: #666;
        }
        
        .error-message {
            color: #d32f2f;
            margin-top: 20px;

        }
    </style>

</head>
<body>
    <div class="processing-container">
        <div class="spinner"></div>
        <h1>Processng Your Payment</h1>
        <p>Please wait while we confirm yout payment with Pesapal</p>
        <p style="font-size: 14px; color: #999; margin-top: 20px; "> Do not close this window or press the back button</p>
        <p class="error-message" id="errorMessage" style="display: none;"></p>
    </div>

    <script>
        const BACKEND_URL = "/api";

        //get payment params from URL
        const urlParams = new URLSearchParams(window.location.search);
        const orderTrackingId = urlParams.get('OrderTrackingId');
        const orderMerchantReference = urlParams.get('OrderMerchantReference');

        console.log('Payment callback received: ', {orderTrackingId, orderMerchantReference});

        if (!orderTrackingId){
            showError('Payment verification failed. Missing tracking ID');
            setTimeout(() => {
                window.location.href = 'checkout.html';
            }, 10000);
        }else{
            verifyPayment(orderTrackingId);
        }

        async function verifyPayment(trackingId) {
            try {
                const response = await fetch(`${BACKEND_URL}/pesapal/verify/${trackingId}`);
                const data = await response.json();

                if (!data.success){
                    throw new Error(data.error || 'Payment verification failed');
                }
                console.log('Payment verification result: ', data);

                if (data.status === 'success'){
                    //payment successfull
                    handleSuccessfulPayment(data);
                }else if (data.status === 'pending'){
                    setTimeout(() => {
                        verifyPayment(trackingId)
                    }, 3000);
                }else{
                    showError('Payment was not successful. Please try again.');
                    setTimeout(()=>{window.location.href='checkout.html'},10000);
                }
            } catch (error) {
                console.error('Verification error: ', error);
                showError('Error verifying payment: ' + error.message);
                setTimeout(()=>{
                    window.location.href = 'checkout.html';
                }, 10000)
            }
        }

        function handleSuccessfulPayment(PaymentData){
            //get pending order from localstorage
            const orderData = JSON.parse(localStorage.getItem('pendingOrder'));
            if (!orderData){
                console.error('No pending order found');
                window.location.href = 'cake-jars.html';
                return
            }

            localStorage.removeItem('cart');
            localStorage.removeItem('pendingOrder');

            //store completed order
            const completedOrders = JSON.parse(localStorage.getItem('completedOrders')) || [];
            completedOrders.push({
                ...orderData,
                paymentData: paymentData,
                completedAt: new Date().toISOString()
            });
            localStorage.setItem('completedOrders', JSON.stringify(completedOrders));

            //redirect to checkout with success parameters
            const params = new URLSearchParams({
                payment: 'success',
                order: orderData.orderNumber,
                email: orderData.customer.email,
                phone: orderData.customer.phone
            });

            window.location.href = `checkout.html?${params.toString()}`;
        }

        function showError(message){
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';

            document.querySelector('.spinner').style.display = 'none';
            document.querySelector('h1').textContent = 'Payment Verification Failed';
            document.querySelector('p').textContent = 'Redirecting you back to checkout...';
        }

    </script>
    
</body>
</html>